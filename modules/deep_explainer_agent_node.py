# modules/deep_explainer_agent_node.py

from textwrap import dedent
from ai_analyzer.llm_manager import LLMManager


class DeepExplainerAgentNode:
    def __init__(self, llm_manager: LLMManager):
        self.llm = llm_manager

    @staticmethod
    def get_system_prompt() -> str:
        return dedent("""
            ë‹¹ì‹ ì€ 'ìª½ì§‘ê°œ ì„ ìƒë‹˜'ì´ë¼ëŠ” ë³„ëª…ì„ ê°€ì§„ ì‹œë‹ˆì–´ ê°œë°œìì…ë‹ˆë‹¤.
            ì£¼ë‹ˆì–´ ê°œë°œìë“¤ì´ í•œ ë‹¨ê³„ ë” ì„±ì¥í•˜ëŠ”ë° í•„ìš”í•œ ì¸ì‚¬ì´íŠ¸ë¥¼ 
            "ì•„, ì´ëŸ° ì‹œê°ìœ¼ë¡œ ë´ì•¼ í•˜ëŠ”êµ¬ë‚˜!" í•˜ê³  ê¹¨ë‹¬ì„ ìˆ˜ ìˆê²Œ ì„¤ëª…í•˜ëŠ” ê²ƒì´ íŠ¹ê¸°ì…ë‹ˆë‹¤.
            ì‹¤ì œ ë§Œë‚˜ì„œ ëŒ€í™”í•˜ëŠ” ê²ƒì²˜ëŸ¼ ì‚¬ëŒì²˜ëŸ¼ ìì—°ìŠ¤ëŸ½ê²Œ ë§í•´ì£¼ì„¸ìš”.
            
            ë‹¹ì‹ ì˜ ì—­í• :
            - ë³µì¡í•œ ê°œë…ì„ 3ì¤„ ìš”ì•½ìœ¼ë¡œ ë¨¼ì € ì„¤ëª…í•˜ê¸°
            - ê²½í—˜ì—ì„œ ìš°ëŸ¬ë‚˜ì˜¨ í•µì‹¬ í†µì°°ë ¥ ì „ë‹¬í•˜ê¸°
            - ë” ë„“ì€ ì‹œì•¼ì™€ ê¹Šì´ ìˆëŠ” ê´€ì  ì œì‹œí•˜ê¸°
            
            ë‹µë³€ ì‘ì„± ì‹œ ìœ ì˜ì‚¬í•­:
            - ì²« ì„¤ëª…ì€ ë¬´ì¡°ê±´ 3ì¤„ ì´ë‚´ë¡œ ê°„ë‹¨í•˜ê²Œ
            - ëª¨ë“  ì„¤ëª…ì— ì‹¤ì œ í˜„ì¥ ê²½í—˜ ë…¹ì—¬ë‚´ê¸°
            - ì¤‘ìš”í•œ ë¶€ë¶„ì€ "ğŸ’¡ ê¹Šì´ ë³´ê¸°" í˜•ì‹ìœ¼ë¡œ ê°•ì¡°
            - ê¸°ìˆ ì  ê¹Šì´ì™€ í•¨ê»˜ ë‹¤ì–‘í•œ ê´€ì  ì œì‹œí•˜ê¸°
            
            ë‹µë³€ êµ¬ì¡°:
            1. 3ì¤„ ìš”ì•½
            2. ğŸ’¡ í•µì‹¬ í†µì°° (ìµœëŒ€ 3ê°œ)
            3. ì‹¤ì œ ì½”ë“œì™€ íŒ¨í„´ ë¹„êµ
            4. ì‹¬í™” ê´€ì  ì†Œê°œ
               - ê¸°ìˆ ì  ê¹Šì´ (ì„±ëŠ¥/ë³´ì•ˆ/ìµœì í™”)
               - ì„¤ê³„ì  ê´€ì  (ì•„í‚¤í…ì²˜/ë””ìì¸íŒ¨í„´)
               - í˜‘ì—…ê³¼ í™•ì¥ (íŒ€ì›Œí¬/ìœ ì§€ë³´ìˆ˜/ìŠ¤ì¼€ì¼ë§)
               - ë¹„ì¦ˆë‹ˆìŠ¤ ì„íŒ©íŠ¸ (ê°€ì¹˜/ë¹„ìš©/ìœ„í—˜)
            5. ë” ê¹Šì´ ìˆëŠ” ì„±ì¥ì„ ìœ„í•œ ë°©í–¥ ì œì‹œ
        """).strip()

    @staticmethod
    def get_user_prompt(final_report: str, feedback: str = "") -> str:
        feedback_section = ""
        if feedback:
            feedback_section = f"""
            @@@ ì´ì „ ë¶„ì„ì˜ ì‹¬ê°í•œ ë¬¸ì œì  @@@
            {feedback}
            
            ìœ„ ë¬¸ì œì ë“¤ì„ ë°˜ë“œì‹œ í•´ê²°í•˜ì—¬ ë‹¤ì‹œ ë¶„ì„í•´ì£¼ì„¸ìš”.
            """

        return dedent(f"""
            ë‹¤ìŒì€ ìµœì¢… ë¦¬í¬íŠ¸ ë‚´ìš©ì…ë‹ˆë‹¤:

            @@@ ë¦¬í¬íŠ¸ ë‚´ìš© ì‹œì‘ @@@
            {final_report}
            @@@ ë¦¬í¬íŠ¸ ë‚´ìš© ë @@@

            {feedback_section}

            ìœ„ ë¦¬í¬íŠ¸ì—ì„œ ê°€ì¥ í•µì‹¬ì ì´ê³  ì‹¬ì¸µì ì¸ ë¶„ì„ì´ í•„ìš”í•œ ì£¼ì œ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì—¬,
            ê¹Šì´ ìˆëŠ” ì¸ì‚¬ì´íŠ¸ë¥¼ ì „ë‹¬í•´ì£¼ì„¸ìš”.
            
            @@@ ë¶„ì„ ì‘ì„± ì§€ì¹¨ @@@
            ì£¼ì œ ì„ íƒ ê¸°ì¤€:
            - ê°œë°œìì˜ ì„±ì¥ì— í•µì‹¬ì´ ë˜ëŠ” ì£¼ì œ
            - ê¸°ìˆ ì  ê¹Šì´ê°€ ìˆëŠ” ì£¼ì œ
            - ì‹¤ë¬´ ê²½í—˜ì´ ë…¹ì•„ìˆëŠ” ì£¼ì œ

            ì„¤ëª… ë°©ì‹:
            - í•µì‹¬ì„ 3ì¤„ë¡œ ë¨¼ì € ìš”ì•½
            - ì‹¤ì œ ê²½í—˜ì— ê¸°ë°˜í•œ í†µì°° ì œì‹œ
            - ë‹¤ì–‘í•œ ê´€ì ìœ¼ë¡œ ê¹Šì´ ìˆê²Œ ë¶„ì„
            - ì‹¤ì „ ì½”ë“œì™€ íŒ¨í„´ìœ¼ë¡œ ì´í•´ë„ ë†’ì´ê¸°

            @@@ ë‹µë³€ êµ¬ì¡° @@@
            ë°˜ë“œì‹œ ì•„ë˜ ë§ˆí¬ë‹¤ìš´ ì–‘ì‹ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•´ì£¼ì„¸ìš”:

            ## [ì£¼ì œëª…] íŒŒí—¤ì¹˜ê¸° ğŸ”
            
            ### í•œëˆˆì— ë³´ê¸° (3ì¤„ ìš”ì•½) âš¡
            - í•µì‹¬ ë‚´ìš©ì„ ì™ì™
            - ì´í•´í•˜ê¸° ì‰½ê²Œ
            - ëª…í™•í•˜ê²Œ
            
            ### ì½”ë“œë¡œ ë³´ëŠ” ì‹¤ì „ ì ìš© ğŸ¯
            ```python
            [ì‹¤ì „ì—ì„œ ì‹œë‹ˆì–´ ê°œë°œìê°€ ì‚¬ìš©í•˜ëŠ” ê°„ëµí•œ ì½”ë“œ ì˜ˆì‹œ]
            ```
            
            ### ë” ê¹Šì´ ë“¤ì–´ê°€ê¸° ğŸš€
            - [ì„±ëŠ¥, ë³´ì•ˆ, ì„¤ê³„, í˜‘ì—…, ë¹„ì¦ˆë‹ˆìŠ¤ ë“± ë‹¤ì–‘í•œ ê´€ì ì—ì„œ ë†“ì¹˜ê¸° ì‰½ì§€ë§Œ ê¼­ ê³ ë ¤í•´ì•¼ í•  ë¶€ë¶„ì„ ë”± í•œê°€ì§€ ì„ ì •í•˜ì—¬ ì˜ˆì‹œì™€ í•¨ê»˜ ê¹Šì´ìˆì§€ë§Œ ì‰½ê²Œ 2-3ì¤„ì— ë‚˜ëˆ„ì–´ ì‘ì„±í•´ì£¼ì„¸ìš”]  
        """).strip()

    async def run(self, final_report: str, feedback: str = "") -> str:
        """
        ìµœì¢… ë¦¬í¬íŠ¸ì—ì„œ í•˜ë‚˜ì˜ í† í”½ì„ ì¶”ì¶œí•˜ê³ ,
        ê·¸ í† í”½ì— ëŒ€í•œ ê¹Šì´ ìˆëŠ” ì„¤ëª…ì„ ì¹œì ˆí•˜ê³  ì‰½ê²Œ ì´í•´í•  ìˆ˜ ìˆê²Œ ìƒì„±í•©ë‹ˆë‹¤.
        """
        system_prompt = self.get_system_prompt()
        user_prompt = self.get_user_prompt(final_report, feedback)

        response = await self.llm.agenerate(prompt=user_prompt, system_prompt=system_prompt, temperature=0.1)
        return response.strip()
